<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academia Policial - Drive Edition</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #003366; --secondary: #0055a5; --bg: #f0f2f5; --text: #333; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; margin-bottom: 20px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { color: var(--primary); text-align: center; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: none; font-weight: bold; color: #666; }
        .tab-btn.active { border-bottom: 3px solid var(--primary); color: var(--primary); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        
        /* FLASHCARDS */
        .fc-box { perspective: 1000px; height: 200px; cursor: pointer; margin: 20px 0; }
        .fc-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; box-shadow: 0 4px 8px rgba(0,0,0,0.1); border-radius: 10px; }
        .fc-box.flipped .fc-inner { transform: rotateY(180deg); }
        .fc-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; font-size: 1.2em; border-radius: 10px; box-sizing: border-box; }
        .fc-front { background: var(--primary); color: white; }
        .fc-back { background: white; color: #333; transform: rotateY(180deg); border: 2px solid var(--primary); }
        .fc-nav { text-align: center; margin-top: 10px; }
        
        /* TEST */
        .quiz-opt { background: #f9f9f9; padding: 10px; margin: 5px 0; border: 1px solid #ddd; cursor: pointer; border-radius: 5px; }
        .quiz-opt.correct { background: #d4edda; }
        .quiz-opt.wrong { background: #f8d7da; }
        
        /* ESTILO PARA EL PDF Y AUDIO */
        .btn { display:inline-block; background: var(--primary); color: white; padding: 10px 20px; text-decoration:none; border-radius:5px; margin-top:10px; }
        .drive-player { border:none; width:100%; height:100px; border-radius:10px; background:#f1f1f1; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h1>üöî Repositorio Policial</h1>
    <div id="app"><p style="text-align:center">Cargando...</p></div>
</div>

<script>
    // 1. CARGAR DATOS
    fetch('database.json?t=' + Date.now())
    .then(r => r.json())
    .then(data => renderApp(data))
    .catch(e => document.getElementById('app').innerHTML = "Error cargando datos. Revisa database.json");

    // 2. RENDERIZAR
    function renderApp(normas) {
        const app = document.getElementById('app');
        app.innerHTML = '';

        normas.forEach((norma, i) => {
            // DETECTAR TIPO DE AUDIO (DRIVE vs OTRO)
            let audioHTML = '';
            if (norma.audio_url) {
                if (norma.audio_url.includes('drive.google.com')) {
                    // TRUCO: Cambiamos 'view' por 'preview' para incrustar el reproductor de Google
                    let drivePreview = norma.audio_url.replace('/view', '/preview').replace('/edit', '/preview');
                    audioHTML = `<iframe class="drive-player" src="${drivePreview}"></iframe>`;
                } else {
                    audioHTML = `<audio controls style="width:100%"><source src="${norma.audio_url}" type="audio/mpeg"></audio>`;
                }
            }

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <h2 onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='none'?'block':'none'" style="cursor:pointer">
                    ${norma.titulo} <i class="fas fa-chevron-down" style="float:right; font-size:0.8em"></i>
                </h2>
                <div style="display:none"> <div class="tabs">
                        <button class="tab-btn active" onclick="openTab(event, 'doc-${i}')">üìñ Norma</button>
                        <button class="tab-btn" onclick="openTab(event, 'fc-${i}')">üß† Estudio</button>
                        <button class="tab-btn" onclick="openTab(event, 'test-${i}')">‚úÖ Test</button>
                        <button class="tab-btn" onclick="openTab(event, 'av-${i}')">üéß Audio</button>
                    </div>

                    <div id="doc-${i}" class="tab-content active">
                        <div style="background:#eef; padding:15px; border-radius:5px;"><strong>Resumen:</strong> ${norma.resumen}</div>
                        ${norma.contenido_html}
                        <br>
                        ${norma.link_fuente ? `<a href="${norma.link_fuente}" target="_blank" class="btn">üìÑ Abrir/Descargar PDF</a>` : ''}
                    </div>

                    <div id="fc-${i}" class="tab-content"><div id="fc-container-${i}"></div></div>
                    <div id="test-${i}" class="tab-content"><div id="quiz-container-${i}"></div><div id="score-${i}" style="text-align:center; font-weight:bold; margin-top:20px;"></div></div>
                    
                    <div id="av-${i}" class="tab-content">
                        <h3>Audio Resumen (NotebookLM)</h3>
                        ${audioHTML}
                        <p style="font-size:0.8em; color:#666; margin-top:5px;">*Si el audio no carga, <a href="${norma.audio_url}" target="_blank">esc√∫chalo directamente aqu√≠</a>.</p>
                    </div>
                </div>
            `;
            app.appendChild(card);
            initFlashcards(i, norma.flashcards);
            initTest(i, norma.test);
        });
    }

    // UTILS
    function openTab(evt, id) {
        evt.target.closest('.card').querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        evt.target.closest('.card').querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        evt.target.classList.add('active');
    }

    // FLASHCARDS
    function initFlashcards(idx, cards) {
        const container = document.getElementById(`fc-container-${idx}`);
        let current = 0;
        function render() {
            if(!cards || !cards.length) return container.innerHTML = "Sin tarjetas.";
            container.innerHTML = `
                <div class="fc-box" onclick="this.classList.toggle('flipped')">
                    <div class="fc-inner">
                        <div class="fc-face fc-front">${cards[current].front}</div>
                        <div class="fc-face fc-back">${cards[current].back}</div>
                    </div>
                </div>
                <div class="fc-nav">
                    <button onclick="changeCard(${idx}, -1)" class="btn" style="padding:5px 10px">‚ùÆ</button>
                    <span style="margin:0 15px">${current+1}/${cards.length}</span>
                    <button onclick="changeCard(${idx}, 1)" class="btn" style="padding:5px 10px">‚ùØ</button>
                </div>`;
        }
        window[`cards_${idx}`] = cards;
        window[`curr_${idx}`] = 0;
        window[`renderFC_${idx}`] = render;
        render();
    }
    window.changeCard = (idx, dir) => {
        let c = window[`curr_${idx}`] + dir;
        let max = window[`cards_${idx}`].length;
        if(c < 0) c = max - 1; if(c >= max) c = 0;
        window[`curr_${idx}`] = c;
        window[`renderFC_${idx}`]();
    }

    // TEST
    function initTest(idx, questions) {
        const container = document.getElementById(`quiz-container-${idx}`);
        let score = 0, answered = 0;
        if(!questions) return;
        
        questions.forEach((q, qId) => {
            let html = `<div style="margin-bottom:15px"><p><strong>${qId+1}. ${q.pregunta}</strong></p>`;
            q.respuestas.forEach((r, rId) => {
                html += `<div class="quiz-opt" id="opt-${idx}-${qId}-${rId}" onclick="check(${idx}, ${qId}, ${rId}, ${q.correcta})">${r}</div>`;
            });
            container.innerHTML += html + `</div>`;
        });

        window[`check`] = (nId, qId, rId, corr) => {
            if(document.getElementById(`opt-${nId}-${qId}-${rId}`).parentElement.getAttribute('done')) return;
            document.getElementById(`opt-${nId}-${qId}-${rId}`).parentElement.setAttribute('done', true);
            
            if(rId === corr) {
                document.getElementById(`opt-${nId}-${qId}-${rId}`).classList.add('correct');
                score++;
            } else {
                document.getElementById(`opt-${nId}-${qId}-${rId}`).classList.add('wrong');
                document.getElementById(`opt-${nId}-${qId}-${corr}`).classList.add('correct');
            }
            answered++;
            if(answered === questions.length) {
                document.getElementById(`score-${nId}`).innerText = `Nota: ${score} / ${questions.length}`;
            }
        };
    }
</script>
</body>
</html>
