<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro de Estudio Policial</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #003366; --secondary: #0055a5; --accent: #ffd700; --bg: #f0f2f5; --text: #333; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        
        /* TARJETAS DE NORMAS */
        .card { background: white; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; }
        .card-header { padding: 20px; background: white; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .card-header h2 { margin: 0; color: var(--primary); font-size: 1.3rem; }
        
        /* MENU DE PESTA√ëAS */
        .tabs { display: flex; background: #f8f9fa; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; cursor: pointer; font-weight: 600; color: #666; transition: 0.3s; }
        .tab-btn.active { background: white; color: var(--secondary); border-bottom: 3px solid var(--secondary); }
        .tab-content { display: none; padding: 25px; }
        .tab-content.active { display: block; }

        /* --- FLASHCARDS (ESTILO CARRUSEL) --- */
        .fc-container { perspective: 1000px; width: 100%; max-width: 500px; height: 300px; margin: 0 auto; position: relative; }
        .fc-card { width: 100%; height: 100%; position: absolute; transform-style: preserve-3d; transition: transform 0.6s; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.1); border-radius: 15px; }
        .fc-card.flipped { transform: rotateY(180deg); }
        .fc-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; text-align: center; font-size: 1.2rem; border-radius: 15px; }
        .fc-front { background: var(--primary); color: white; }
        .fc-back { background: white; color: var(--text); transform: rotateY(180deg); border: 2px solid var(--primary); }
        
        .fc-controls { text-align: center; margin-top: 20px; }
        .fc-btn { background: var(--secondary); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; margin: 0 10px; }
        .fc-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- TEST (ESTILO EXAMEN) --- */
        .quiz-container { max-width: 600px; margin: 0 auto; }
        .quiz-question { margin-bottom: 20px; padding: 15px; background: #fff; border: 1px solid #eee; border-radius: 8px; }
        .quiz-opt { display: block; padding: 12px; margin: 8px 0; background: #f8f9fa; border: 1px solid #ddd; border-radius: 5px; cursor: pointer; transition: 0.2s; }
        .quiz-opt:hover { background: #e2e6ea; }
        .quiz-opt.correct { background: #d4edda; border-color: #28a745; color: #155724; }
        .quiz-opt.wrong { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .quiz-score { text-align: center; font-size: 1.5rem; font-weight: bold; margin-top: 20px; color: var(--secondary); display: none; }
        
        /* --- AUDIO --- */
        audio { width: 100%; margin-top: 15px; border-radius: 30px; }
    </style>
</head>
<body>

<div class="container">
    <div style="text-align:center; margin-bottom:30px;">
        <h1><i class="fas fa-university"></i> Academia Digital Policial</h1>
        <input type="text" id="search" placeholder="üîç Buscar norma..." onkeyup="render()" style="padding:10px; width:80%; border-radius:20px; border:1px solid #ccc;">
    </div>

    <div id="app">Cargando datos...</div>
</div>

<script>
    let BBDD = [];

    // 1. CARGA DE DATOS
    fetch('database.json?v=' + Date.now())
        .then(r => r.json())
        .then(data => {
            BBDD = data;
            render();
        })
        .catch(e => document.getElementById('app').innerHTML = "Error cargando database.json");

    // 2. CONVERTIDOR DE ENLACES DRIVE (EL TRUCO M√ÅGICO)
    function fixDriveLink(link) {
        if (!link) return "";
        if (link.includes("drive.google.com")) {
            // Extrae el ID del archivo y crea un enlace directo de descarga/streaming
            const id = link.match(/[-\w]{25,}/);
            if (id) return `https://drive.google.com/uc?export=download&id=${id[0]}`;
        }
        return link; // Si no es de Drive, lo devuelve tal cual
    }

    // 3. RENDERIZADO
    function render() {
        const term = document.getElementById('search').value.toLowerCase();
        const app = document.getElementById('app');
        app.innerHTML = '';

        BBDD.forEach((item, idx) => {
            if (!item.titulo.toLowerCase().includes(term)) return;

            // Preparar HTML del Test
            let quizHTML = item.test.map((q, qIdx) => `
                <div class="quiz-question" id="q-${idx}-${qIdx}">
                    <strong>${qIdx + 1}. ${q.pregunta}</strong>
                    <div class="opts">
                        ${q.respuestas.map((r, rIdx) => `
                            <div class="quiz-opt" onclick="answerQuiz(${idx}, ${qIdx}, ${rIdx}, ${q.correcta}, this)">${r}</div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            quizHTML += `<div id="score-${idx}" class="quiz-score"></div>`;

            // Preparar HTML de Flashcards (Solo la primera visible)
            let fcHTML = `
                <div class="fc-container" id="fc-cont-${idx}">
                    <div class="fc-card" onclick="this.classList.toggle('flipped')" id="fc-card-${idx}">
                        <div class="fc-face fc-front" id="fc-front-${idx}">${item.flashcards[0].front}</div>
                        <div class="fc-face fc-back" id="fc-back-${idx}">${item.flashcards[0].back}</div>
                    </div>
                </div>
                <div class="fc-controls">
                    <button class="fc-btn" onclick="moveCard(${idx}, -1)">‚ùÆ Anterior</button>
                    <span id="fc-count-${idx}">1 / ${item.flashcards.length}</span>
                    <button class="fc-btn" onclick="moveCard(${idx}, 1)">Siguiente ‚ùØ</button>
                </div>
            `;

            // HTML Principal
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-header" onclick="toggleBody(this)">
                    <h2>${item.titulo}</h2>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="card-body" style="display:none">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="openTab(event, 'doc-${idx}')">Norma</button>
                        <button class="tab-btn" onclick="openTab(event, 'fc-${idx}')">Estudio</button>
                        <button class="tab-btn" onclick="openTab(event, 'test-${idx}')">Test</button>
                        <button class="tab-btn" onclick="openTab(event, 'av-${idx}')">Audio</button>
                    </div>
                    
                    <div id="doc-${idx}" class="tab-content active">
                        ${item.contenido_html}
                        <br><br>
                        ${item.link_fuente ? `<a href="${item.link_fuente}" target="_blank" style="background:#ddd; padding:10px; border-radius:5px; text-decoration:none; color:#333;">üìÑ Ver PDF Original</a>` : ''}
                    </div>

                    <div id="fc-${idx}" class="tab-content">
                        ${fcHTML}
                        <script>window['fcIndex_${idx}'] = 0;</script>
                    </div>

                    <div id="test-${idx}" class="tab-content">
                        ${quizHTML}
                        <script>window['score_${idx}'] = 0; window['answered_${idx}'] = 0;</script>
                    </div>

                    <div id="av-${idx}" class="tab-content">
                        <h3>Audio Resumen</h3>
                        <audio controls>
                            <source src="${fixDriveLink(item.audio_url)}" type="audio/mpeg">
                            Tu navegador no soporta el audio.
                        </audio>
                    </div>
                </div>
            `;
            app.appendChild(card);
            
            // Inicializar contadores
            window[`fcIndex_${idx}`] = 0;
            window[`score_${idx}`] = 0;
            window[`answered_${idx}`] = 0;
        });
    }

    // --- FUNCIONES INTERACTIVAS ---

    function toggleBody(header) {
        const body = header.nextElementSibling;
        body.style.display = body.style.display === 'none' ? 'block' : 'none';
    }

    function openTab(e, id) {
        const parent = e.target.closest('.card-body');
        parent.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
        parent.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).style.display = 'block';
        e.target.classList.add('active');
    }

    // FLASHCARDS LOGIC
    function moveCard(normaIdx, direction) {
        const cards = BBDD[normaIdx].flashcards;
        let current = window[`fcIndex_${normaIdx}`];
        let next = current + direction;

        if (next < 0) next = cards.length - 1;
        if (next >= cards.length) next = 0;

        window[`fcIndex_${normaIdx}`] = next;

        // Update UI
        const cardEl = document.getElementById(`fc-card-${normaIdx}`);
        cardEl.classList.remove('flipped'); // Reset flip
        
        setTimeout(() => {
            document.getElementById(`fc-front-${normaIdx}`).innerText = cards[next].front;
            document.getElementById(`fc-back-${normaIdx}`).innerText = cards[next].back;
            document.getElementById(`fc-count-${normaIdx}`).innerText = `${next + 1} / ${cards.length}`;
        }, 200);
    }

    // TEST LOGIC
    function answerQuiz(normaIdx, qIdx, rIdx, correctIdx, btn) {
        const parent = document.getElementById(`q-${normaIdx}-${qIdx}`);
        if (parent.classList.contains('answered')) return; // Prevent retry

        parent.classList.add('answered');
        const opts = parent.getElementsByClassName('quiz-opt');

        if (rIdx === correctIdx) {
            btn.classList.add('correct');
            window[`score_${normaIdx}`]++;
        } else {
            btn.classList.add('wrong');
            opts[correctIdx].classList.add('correct'); // Show correct one
        }

        // Check completion
        window[`answered_${normaIdx}`]++;
        const total = BBDD[normaIdx].test.length;
        
        if (window[`answered_${normaIdx}`] === total) {
            const scoreDiv = document.getElementById(`score-${normaIdx}`);
            const score = window[`score_${normaIdx}`];
            scoreDiv.style.display = 'block';
            scoreDiv.innerText = `Resultado Final: ${score} / ${total}`;
            if(score >= total/2) scoreDiv.style.color = 'green';
            else scoreDiv.style.color = 'red';
        }
    }
</script>

</body>
</html>
